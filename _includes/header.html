<!-- _includes/header.html -->
<header class="modern-header" role="banner" aria-label="Main header" style="visibility:visible;opacity:1;">
    <div class="header-container">
        <div class="header-logo">
            <a href="{{ '/' | relative_url }}">
                <img src="{{ '/assets/images/logo.png' | relative_url }}" alt="{{ site.title | default: 'Site' }}" id="site-logo">
            </a>
        </div>

        <div class="header-search-wrapper">
            <div class="search-box">
                <input type="text" id="header-search-input" placeholder="ক্যাটাগরি, বই বা লেখকের নাম খুঁজুন..." autocomplete="off" aria-label="Search">
                <i class="fas fa-search search-icon-btn" id="search-lens" aria-hidden="true"></i>
                <i class="fas fa-times clear-btn" id="search-clear" aria-hidden="true" title="Clear search"></i>
            </div>
            <div class="search-results-dropdown" id="header-search-results" aria-live="polite" role="listbox"></div>
        </div>

        <div class="header-menu" role="navigation" aria-label="Main menu">
            <ul class="menu-links" id="menu-links">
                <li><a href="{{ '/' | relative_url }}">Home</a></li>
                <li><a href="{{ '/books' | relative_url }}">Books</a></li>
                <li><a href="{{ '/electronics' | relative_url }}">Electronics</a></li>
                <li><a href="{{ '/groceries' | relative_url }}">Groceries</a></li>
                <li><a href="{{ '/ghorer_bazar' | relative_url }}">Ghorer Bazar</a></li>
            </ul>
            <div class="hamburger" id="hamburger" aria-label="Open mobile menu" role="button" tabindex="0">
                <i class="fas fa-bars" aria-hidden="true"></i>
            </div>
        </div>
    </div>
</header>

<script>
/* Header script: search, mobile menu, and helper functions.
   Waits for DOMContentLoaded; safe to include in header.
*/
document.addEventListener('DOMContentLoaded', function() {
    (function revealHeader(){
      const hdr = document.querySelector('header.modern-header');
      if(hdr){
        hdr.style.visibility = 'visible';
        hdr.style.opacity = '1';
      }
    })();

    const searchInput = document.getElementById('header-search-input');
    const resultsContainer = document.getElementById('header-search-results');
    const clearBtn = document.getElementById('search-clear');
    const searchLens = document.getElementById('search-lens');
    const hamburger = document.getElementById('hamburger');
    const menuLinks = document.getElementById('menu-links');

    // Mobile menu toggle with icon switch
    if(hamburger && menuLinks){
        hamburger.addEventListener('click', (ev) => {
            ev.stopPropagation();
            menuLinks.classList.toggle('active');
            const icon = hamburger.querySelector('i');
            if (menuLinks.classList.contains('active')) {
                icon.classList.remove('fa-bars'); icon.classList.add('fa-times');
                hamburger.setAttribute('aria-expanded', 'true');
            } else {
                icon.classList.remove('fa-times'); icon.classList.add('fa-bars');
                hamburger.setAttribute('aria-expanded', 'false');
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburger.contains(e.target) && !menuLinks.contains(e.target) && menuLinks.classList.contains('active')) {
                menuLinks.classList.remove('active');
                const icon = hamburger.querySelector('i');
                icon.classList.remove('fa-times'); icon.classList.add('fa-bars');
                hamburger.setAttribute('aria-expanded', 'false');
            }
        });
    }

    // Build small client-side DB (scans any .product-card present)
    let productDatabase = [];
    try {
      const cards = document.querySelectorAll('.product-card');
      cards.forEach(card => {
          productDatabase.push({
              title: (card.getAttribute('data-title') || '').trim(),
              author: (card.getAttribute('data-author') || '').trim(),
              seller: (card.getAttribute('data-seller') || '').trim(),
              img: (card.getAttribute('data-img') || '').trim(),
              link: (card.getAttribute('data-href') || '#').trim()
          });
      });
    } catch (e) {
      productDatabase = [];
    }

    // Demo entries (optional; remove if you want)
    productDatabase.push(
      { title: "ল্যাপটপ - এইচপি কোর আই ৫", img: "{{ '/assets/images/logo.png' | relative_url }}", link: "/electronics" },
      { title: "মিনিকেট চাল - ৫ কেজি", img: "{{ '/assets/images/logo.png' | relative_url }}", link: "/groceries" }
    );

    // When header emits an 'app:search-request' event, app.js will perform search. We dispatch here.
    if(searchInput){
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            // make search UI choices locally (show clear, hide lens)
            if (query.length > 0) {
                if (clearBtn) clearBtn.style.display = 'block';
                if (searchLens) searchLens.style.display = 'none';
            } else {
                if (clearBtn) clearBtn.style.display = 'none';
                if (searchLens) searchLens.style.display = 'block';
                if (resultsContainer) resultsContainer.style.display = 'none';
            }
            // dispatch event for app.js to use
            const event = new CustomEvent('app:search', { detail: query });
            document.dispatchEvent(event);
        });
    }

    // clear button behaviour
    if(clearBtn){
        clearBtn.addEventListener('click', function() {
            if(searchInput) searchInput.value = '';
            if(resultsContainer) resultsContainer.style.display = 'none';
            clearBtn.style.display = 'none';
            if(searchLens) searchLens.style.display = 'block';
            if(searchInput) searchInput.focus();
            // notify app.js to clear
            document.dispatchEvent(new CustomEvent('app:search', { detail: '' }));
        });
    }

    // expose small built DB for app.js if needed
    window.HEADER_PRODUCT_DB = productDatabase;

    // helper used by request button in search no-result block
    window.triggerRequest = function(searchTerm) {
        if(resultsContainer) resultsContainer.style.display = 'none';
        if(searchInput) searchInput.value = '';
        if(clearBtn) clearBtn.style.display = 'none';
        if(searchLens) searchLens.style.display = 'block';

        const requestArea = document.getElementById('request-area') || document.getElementById('footer') || document.querySelector('.main-footer');
        const productInput = document.getElementById('product-name');

        if (requestArea) {
            requestArea.scrollIntoView({ behavior: 'smooth' });
            if (productInput && searchTerm) {
                productInput.value = searchTerm;
                setTimeout(() => productInput.focus(), 800);
            }
        } else {
            alert("রিকোয়েস্ট ফর্মের জন্য পেজের নিচে যান।");
        }
    };
});
</script>
